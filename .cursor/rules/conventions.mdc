---
alwaysApply: true
---

# Правила разработки кода

> См. [vision.md](vision.md) для полного технического видения проекта.

## Общие принципы

**KISS/MVP:** только необходимый функционал. Никакого оверинжиниринга. Максимально простое решение.

**Минимум абстракций:** не создавать интерфейсы/протоколы без реальной необходимости. In-memory storage — простые dict/list с обёртками-функциями.

## Структура кода

- **Handlers** (`bot/handlers/`): принимают события Telegram, валидируют ввод, вызывают сервисы, формируют ответы/клавиатуры. Минимум бизнес-логики.
- **Services** (`bot/services/`): вся бизнес-логика (каталог, корзина, заказы, расчёт сумм, валидации).
- **Storage** (`bot/storage.py`): простые операции с dict/list. Без БД, без ORM, без сложных транзакций.
- **Keyboards** (`bot/keyboards/`): формирование разметки кнопок.

## Данные

- In-memory: dict для каталога/корзин/заказов, keyed by user_id или id.
- Модели данных — простые dataclass или NamedTuple (без Pydantic на MVP).
- Нет миграций, нет схем БД — всё в коде/инициализации.

## Типы и аннотации

- Используем type hints для основных функций (не везде подряд).
- Optional/Union — только где реально нужно.

## Обработка ошибок

- Простые try/except с логированием.
- Валидация входных данных в handlers.
- В бизнес-логике — явные проверки (if item.available, if weight in item.weights).

## Тестирование

- Тесты только на ключевое: корзина, расчёт суммы, валидации.
- pytest, простые unit-тесты без фикстур/моков без необходимости.

## Именование

- Функции/переменные: snake_case.
- Классы (если нужны): PascalCase.
- Константы: UPPER_SNAKE_CASE.
- Понятные имена, не аббревиатуры без необходимости.

## Импорты

- Группировка: stdlib → внешние → локальные.
- Минимум импортов, только используемое.

## Комментарии

- Только где логика неочевидна. Docstrings — опционально на MVP.

## Логирование

- `logging` модуль, уровень INFO по умолчанию.
- Логируем: ошибки, оформление заказов, успешные/неуспешные оплаты.
- Формат: `%(asctime)s %(levelname)s %(message)s`.

## Зависимости

- Минимум внешних пакетов: aiogram v3, pytest для тестов.
- Без лишних утилит (валидаторы, helpers-библиотеки) — пишем простое сами.

## Что нельзя делать

- **Внешние БД:** PostgreSQL, Redis и т.д. Только in-memory dict/list.
- **Микросервисы и сложные архитектуры:** один монолитный бот, один процесс.
- **Async/await без крайней необходимости:** aiogram уже async, не усложнять дополнительными async-операциями без реальной потребности.
- **Сложные конфиг-файлы:** YAML, JSON конфиги. Только переменные окружения.
- **Избыточные абстракции и классы:** минимум классов, предпочтение простым функциям.
- **Полное покрытие тестами:** тестируем только ключевое (корзина, расчёт суммы, валидации).
- **Сложные системы мониторинга:** без Prometheus/Grafana/Sentry, только базовое логирование.

## Что можно делать

- **Простые функции и минимум классов:** функции вместо классов где возможно.
- **Один файл — одна ответственность:** каждый модуль решает одну задачу.
- **Понятные имена переменных и функций:** явные названия, без аббревиатур без необходимости.
- **Базовое логирование всех операций:** логируем ключевые события (ошибки, заказы, оплаты).
- **Обработка основных ошибок:** try/except для критичных операций с логированием.
- **Документирование только API функций:** docstrings только для публичных API функций.

---

**Если сомневаешься — выбирай самое простое решение.**
